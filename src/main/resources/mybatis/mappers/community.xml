<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="community">
	
	<!-- 쿼리문 작성 -->
	
	<!-- select 예제 -->
	<select id="selectList" parameterType="int" resultType="CommunityVo">
		<![CDATA[
			
   					SELECT   c.cpostNo, 
					 c.cpostType, 
					 u.userNo, 
                     regDate,
					 c.cpostTitle,
					 c.cpostContent,
					 c.liked,
                     (select count(*) from communityreply r
                      where c.cpostNo = r.cpostNo) as replyCount 
			FROM  communitypost c join users u
			ON c.userNo = u.userNo
			where c.cpostType = #{cpostType}
			order by c.cpostNo desc
			
		]]>
	</select>
	
	
	<select id="MainEatList" resultType="CommunityVo">
		<![CDATA[
			
   				SELECT   c.cpostNo, 
					 c.cpostType, 
					 u.userNo, 
                     TO_CHAR(regDate,'hh24:mi') as regDate,
					 c.cpostTitle,
					 c.cpostContent,
					 c.liked,
					 (select count(*) from communityreply r
                      where c.cpostNo = r.cpostNo) as replyCount 
			FROM  communitypost c join users u
			ON c.userNo = u.userNo
			where c.cpostType = 1  and rownum <=5
			order by c.cpostNo desc
			
		]]>
	</select>
	
		
	<select id="MaincafeList" resultType="CommunityVo">
		<![CDATA[
			
   				SELECT   c.cpostNo, 
					 c.cpostType, 
					 u.userNo, 
                     TO_CHAR(regDate,'hh24:mi') as regDate,
					 c.cpostTitle,
					 c.cpostContent,
					 c.liked,
					 (select count(*) from communityreply r
                      where c.cpostNo = r.cpostNo) as replyCount 
			FROM  communitypost c join users u
			ON c.userNo = u.userNo
			where c.cpostType = 2  and rownum <=5
			order by c.cpostNo desc
			
		]]>
	</select>
	<select id="MainList" resultType="CommunityVo">
		<![CDATA[
			
   				SELECT   c.cpostNo, 
					 c.cpostType, 
					 u.userNo, 
                     TO_CHAR(regDate,'hh24:mi') as regDate,
					 c.cpostTitle,
					 c.cpostContent,
					 c.liked,
					 (select count(*) from communityreply r
                      where c.cpostNo = r.cpostNo) as replyCount 
			FROM  communitypost c join users u
			ON c.userNo = u.userNo
			where c.cpostType = 3  and rownum <=5
			order by c.cpostNo desc
			
		]]>
	</select>
	
		
	<select id="selectLiked" parameterType="int" resultType="CommunityVo">
		<![CDATA[
			select cpostTitle,regDate,liked
            from (
                select * 
                from communitypost 
                where cposttype = #{cposttype}
                order by liked desc
            )
            where  rownum <= 10	
		]]>
	</select>

	<!-- no로 글조회 -->
	<select id="selectNotice" parameterType="int" resultType="CommunityVo">
		<![CDATA[
			select cpostNo, 
					   cpostTitle, 
					   cpostContent,
					   cpostType,
					   liked, 
					   TO_CHAR(regDate, 'yyyy/mm/dd') as regDate,  
					   userNo,
					   (select count(*) from communityreply r
                      where c.cpostNo = r.cpostNo) as replyCount 
			     from communitypost c
			     where cpostNo = #{cpostNo}     
			     
		]]>
	</select>
	

	
	<select id="selectLocation" parameterType="String" resultType="LocationVo">
		<![CDATA[
			SELECT locationNo
			FROM location
			where address = #{address}
		]]>
	</select>
	
	<insert id="insertPost" parameterType="CommunityVo">
		<selectKey keyProperty="cpostNo" resultType="int" order="BEFORE">
			select seq_cpost_no.nextval from dual
		</selectKey>
		<![CDATA[
			INSERT INTO COMMUNITYPOST
				(cpostNo,
				 cpostTitle,
				 cpostContent,
				 userNo,
				 cpostType,
				 regDate,
				 liked,
				 replyCount)
			VALUES
				(#{cpostNo},
				 #{cpostTitle},
				 #{cpostContent},
				 #{userNo},
				 #{cpostType},
				 SYSDATE,
				 0,
				 #{replyCount}
				)
		]]>
	</insert>
	
	<update id="updateliked" parameterType="int" >
		<![CDATA[
			update COMMUNITYPOST 
			set liked = liked+1
			where cpostNo = #{cpostNo}
		]]>
	</update>
	
	
	<update id="updateunliked" parameterType="int">
		<![CDATA[
			update COMMUNITYPOST 
			set liked = liked-1
			where cpostNo = #{cpostNo}
		]]>
	</update>	
	
	
	
	
	<select id="countReply" parameterType="communityvo" resultType="int">
	<![CDATA[
			 select count(*) from COMMUNITYPOST where cpostNo=#{cpostNo}
		]]>
	</select>
	
	<delete id="deletereply" parameterType="communityvo">
		<![CDATA[
			delete from communityreply 
			where cpostNo = #{cpostNo}
		]]>
	</delete>
	
	<!-- 글삭제 -->
	<delete id="delete" parameterType="communityvo">
		<![CDATA[
			delete from COMMUNITYPOST 
			where userNo = #{userNo}
			and cpostNo = #{cpostNo}
		]]>
	</delete>
	
	
	
	<insert id="insertLocation" parameterType="CommunityVo">
		<selectKey keyProperty="locationNo" resultType="int" order="BEFORE">
			select seq_location_no.nextval from dual
		</selectKey>
		<![CDATA[
			INSERT INTO LOCATION
				(businessName,
				 address,
				 longitude,
				 latitude,
				 locationNo)
			VALUES
				(#{businessName},
				 #{address},
				 #{longitude},
				 #{latitude},
				 #{locationNo})
		]]>
	</insert>
	
	<insert id="insertLocationPost" parameterType="map">
		<![CDATA[
			INSERT INTO LOCATIONPOST
				(locationPostNo,
				 locationNo,
				 cpostNo)
			VALUES
				(seq_locationpost_no.nextval,
				#{locationNo},
				#{cpostNo})
		]]>
	</insert>
	
	<insert id="insertFile" parameterType="fileUpLoadVo">
		<selectKey keyProperty="fileNo" resultType="int" order="BEFORE">
			select seq_datafile_no.nextval from dual
		</selectKey>
		<![CDATA[
			INSERT INTO DATAFIlE
				(fileNo,
				 fileName,
				 saveName,
				 fileSize,
				 regDate,
				 filepath)
			VALUES
				(#{fileNo},
				 #{fileName},
				 #{saveName},
				 #{fileSize},
				 SYSDATE,
				 #{filepath})
		]]>
	</insert>
	
	<insert id="insertCommunityFile" parameterType="map">
		<![CDATA[
			INSERT INTO COMMUNITYFILE
				(cfileNo,
				 cpostNo,
				 fileNo)
			VALUES
				(seq_cfile_no.nextval,
				 #{cpostNo},
				 #{fileNo})
		]]>
	</insert>
	
	
	
	

</mapper>
