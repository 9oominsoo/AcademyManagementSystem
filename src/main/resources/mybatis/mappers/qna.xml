<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="qna">


	<!--검색하는 기능  -->
	<select id="searchList" parameterType="PostVo" resultType="PostVo">
	<![CDATA[
	SELECT * FROM post WHERE posttitle LIKE '%'||#{postTitle}||'%'  ORDER BY REGDATE DESC
	]]>
	</select>
	
	<!-- 포스트 총 갯수  -->
	<select id="countPost"  resultType="int">
	<![CDATA[
 	   select count(*) from post where postType= 2
	]]>
	</select>
	
	

	<select id="selectListPaging" parameterType="map" resultType="PostVo">
		<![CDATA[
		        
		                
         SELECT  rnum as rnum,
		        postNo,
		        postType,
		        userNo,
		        courseNo,
		        regDate,
		        communityNo,
		        scheduleNo,
		        postTitle,
		        postContent,
		        hit,
		        category,
		        userName,
		        subjectNo,
		        subjectTitle,
                replyCount
		FROM (
				SELECT    rownum as rnum, 
		                a.postNo,
		                a.postType,
		                a.userNo,
		                a.courseNo courseNo,
		                a.regDate,
		                a.communityNo,
		                a.scheduleNo scheduleNo,
		                a.postTitle,
		                a.postContent,
		                a.hit,
		                a.category,
		                a.userName,
		                a.subjectNo,
		                a.subjectTitle,
		                a.replyCount
		           
        FROM(
					SELECT    rownum as rnum, 
					                pu.postNo,
					                pu.postType,
					                pu.userNo,
					                pu.courseNo courseNo,
					                pu.regDate,
					                pu.communityNo,
					                pu.scheduleNo scheduleNo,
					                pu.postTitle,
					                pu.postContent,
					                pu.hit,
					                pu.category,
					                pu.userName,
					                pu.subjectNo,
					                s.subjectTitle,
					                (select count(*) from reply r 
					        	where r.postNo = pu.postNo) as replyCount
		        FROM(
		                SELECT  postNo,
		                        postType,
		                        p.userNo userNo,
		                        courseNo,
		                        TO_CHAR(regDate, 'yyyy/mm/dd') as regDate,
		                       communityNo,
		                        scheduleNo,
		                        postTitle,
		                        postContent,
		                        hit,
		                        category,
		                        userName,
		                        subjectNo
		                FROM post p join users u
		                ON p.userNo = u.userNo
		                where postType = 2)pu
		                left join subject s 
		                on pu.subjectno = s.subjectno 
		                order by pu.postNo desc) a
		                where rownum <= #{pageNo2} ) 
		                where rnum >= #{pageNo1}
		                order by  rnum asc
		]]>
	</select>


	<!-- no로 글조회 -->
	<select id="selectNotice" parameterType="int" resultType="PostVo">
		<![CDATA[
		SELECT  postNo, 
			    postTitle, 
			    postContent,
			    hit, 
			    regDate, 
			    userNo, 
                subjectTitle
        FROM(
				select postNo, 
					   postTitle, 
					   postContent,
					   hit, 
					   TO_CHAR(regDate, 'yyyy/mm/dd') as regDate,  
					   userNo,
					   p.subjectNo subjectNo,
					   subjectTitle
			     from post p join subject s
			     on p.subjectno = s.subjectno) 
			     where postNo = #{postNo}     
			     
		]]>
	</select>

	<!-- 조회수 증가 -->
	<update id="updateHit" parameterType="int">
		<![CDATA[
			update post 
			set hit = hit+1
			where postNo = #{postNo}
		]]>
	</update>



	<!-- 글저장 -->
	<insert id="insert" parameterType="PostVo">
		<![CDATA[
			insert into post(postNo,postType,userNo,courseNo,regDate,postTitle,postContent,hit,subjectNo)
			values (
					seq_post_no.nextval,
					2,
					#{userNo},	
					1,	
					sysdate,		 
					#{postTitle}, 					
					#{postContent}, 
					#{hit},
					#{subjectNo}
			) 
		]]>
	</insert>


	<!-- 과목리스트 -->
	<select id="selectSubjectAll" parameterType="int" resultType="SubjectVo">
		<![CDATA[
							
				
				SELECT   subjectNo,
				        subjectTitle
				        FROM subject 
		]]>
	</select>



	<!-- 글삭제 -->
	<delete id="delete" parameterType="PostVo">
		<![CDATA[
			delete from post 
			where userNo = #{userNo}
			and postNo = #{postNo}
		]]>
	</delete>
	
	<delete id="deletereply" parameterType="PostVo">
		<![CDATA[
			delete from reply 
			where postNo = #{postNo}
		]]>
	</delete>
	
	
	<!-- 글수정 -->
	<update id="update" parameterType="PostVo">
		<![CDATA[
			update post 
		   	set postTitle=#{postTitle},
		       	postContent=#{postContent},
		       	subjectNo=#{subjectNo},
		       	regDate=sysdate
		 	where postNo=#{postNo}
		  	and userNo = #{userNo}
		]]>
	</update>
	

</mapper>
