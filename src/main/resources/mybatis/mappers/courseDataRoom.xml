<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="courseDataRoom">

	<!-- 왼쪽 폴더 리스트들 틀림 -->
	<select id="selectFolderList" resultType="CourseDataRoomVo">
		<![CDATA[
		select 	dataRoomNo, 
				dataRoomName, 
				pRoomNo 
		from dataRoom where courseNo=1 
		order by pRoomNo and dataRoomNo
		]]>
	</select>


	<!--처음 코스 전용 자료실 페이지 들어가면 오른쪽에 있는 파일리스트들 -->
	<select id="selectFileListAtFirst"
		parameterType="CourseDataRoomVo" resultType="CourseDataRoomVo">
		<![CDATA[
		select dataroomno, dataroomname 
		from dataroom 
		where proomno=  (select dataroomno from dataroom where courseno=#{courseNo} and proomno=0)
		union
		select d.fileno as fileNo, d.filename as fileName
		from dataroomfile dr join datafile d 
		on dr.fileno=d.fileno where dr.dataroomno = (select dataroomno from dataroom where courseno=#{courseNo} and proomno=0)
		]]>
	</select>

	<!-- 폴더를 클릭했을때 dataroomno 를 받고 file 과 폴더 리스트를 받는다 -->
	<select id="selectFileClickedByFolder"
		resultType="CourseDataRoomVo">
		<![CDATA[
		select dataroomno, dataroomname as filelist 
		from dataroom 
		where proomno=2
		union
		select d.fileno, d.filename  as filelist  
		from dataroomfile dr join datafile d 
		on dr.fileno=d.fileno where dr.dataroomno =2
		]]>
	</select>


	<!-- tag를 이용하여 파일들을 선택가능하게 하는 법 -->
	<!-- 1.태그를 나열한다 -->
	<select id="selectTagList" resultType="CourseDataRoomVo">
		<![CDATA[
			select dataTagNo , dataTagName from dataTag
		]]>
	</select>

	<!-- 2.태그중에 하나를 클릭해서 datatagno를 가져온다 -->
	<select id="SelectTagOnByDataTagNo" resultType="CourseDataRoomVo">
		<![CDATA[
		select 	df.fileno as fileNo, 
				df.savename as saveName, 
				df.filepath as filePath 
		from datafile df join (select 
                                a.dataroomfileno ,
                                a.dataroomno, 
                                a.fileno   
                     		  from dataroomfiletag drft 
                      		  join (select 
                                    	drf.dataroomfileno, 
                                    	drf.fileno, 
                                    	drf.dataroomno 
                      		  		from dataroom dr 
                      		  		join dataroomfile drf 
                      		  		on dr.dataroomno=drf.dataroomno 
                      		  		where dr.courseno=#{courseNo}
                      		  ) a
        			  		  on drft.dataroomfileno=a.dataroomfileno where drft.datatagno= #{dataTagNo} ) b
		on df.fileno=b.fileno
		]]>
	</select>


	<!-- dataroomno를 받은 상태에서 폴더를 업로드한다 태그도 추가하고 -->

	<insert id="insertFileUpLoad" parameterType="CourseDataRoomVo">
		<selectKey keyProperty="dataFileNo" resultType="int" order="BEFORE">
			select seq_datafile_no.nextval from dual
		</selectKey>
		<![CDATA[
			insert into datafile values(
            	dataFileNo,
            	#{fileName},
            	#{savaName},
            	#{fileSize},
            	sysdate,
            	#{filePath}
            )
		]]>
	</insert>

	<insert id="insertDataRoomFile" parameterType="CourseDataRoomVo">
		<selectKey keyProperty="dataRoomFileNo" resultType="int" order="BEFORE">
			select seq_dataroomfile_no.nextval from dual
		</selectKey>
		<![CDATA[
			insert into dataroomfile values(
            	dataRoomFileNo,
            	#{dataRoomNo},
            	#{fileNo}
            )
		]]>
	</insert>

	<insert id="insertDataRoomFileTag" parameterType="CourseDataRoomVo">
		<![CDATA[
			insert into dataroomfiletag values (
            	seq_dataroomfiletag_no.nextval,
            	#{dataRoomFileNo},
            	#{dataTagNo}
            )
		]]>
	</insert>


	<select id="selectRootFolderList" parameterType="CourseDataRoomVo" resultType="CourseDataRoomVo">
	<![CDATA[
	select 	dataRoomNo , 
			dataRoomName, 
			courseNo, 
			pRoomNo 
	from dataroom 
	where pRoomNo=#{pRoomNo} and courseNo=#{courseNo}
	]]>
	</select>

	<select id="selectRootFolder" parameterType="CourseDataRoomVo"
		resultType="CourseDataRoomVo">
	<![CDATA[
	select 	dataRoomNo , 
			dataRoomName, 
			courseNo, 
			pRoomNo 
	from dataroom 
	where courseNo=#{courseNo}
	]]>
	</select>

	<select id="selectUpFolder" parameterType="CourseDataRoomVo" resultType="CourseDataRoomVo">
	<![CDATA[
	select dataRoomNo, dataRoomName, pRoomNo from dataRoom where dataRoomNo=#{pRoomNo}
	]]>
	</select>
</mapper>
